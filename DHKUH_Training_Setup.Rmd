---
title: "Data Analysis Training Setup - DHKUH 062025"
author: "Heather Amato"
date: "2025-06-20"
output: html_document
---

## Summary:
This script can be used to generate simulated datasets, including household 
survey data, microbial data (IDEXX QuantiTray and plating results), and 
Taqman Array Card (TAC) qPCR output files for 3 different sample types.  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir ="/Users/hkamato/Desktop/GitHub/DHKUH Data Analysis Training")

# Load required packages
library(tidyverse)
library(lubridate)
```

## Create IDs and sample types
```{r}
# Household/sample IDs and sample types
household_ids <- paste0("HH", sprintf("%03d", 1:140))
sample_types <- c("effluent", "compost", "produce")

# Create full sample-level dataset
sample_metadata <- expand.grid(
  household_id = household_ids,
  sample_type = sample_types,
  stringsAsFactors = FALSE
) %>%
  arrange(household_id, sample_type) %>%
  mutate(sample_id = paste0(household_id, "_", sample_type))
```

## Simulate survey data
```{r survey}

# Create 140 household IDs
household_ids <- paste0("HH", sprintf("%03d", 1:140))

# Create tole variable: 20 toles with 7 households each
tole_ids <- paste0("Tole_", sprintf("%02d", 1:20))
tole_assignment <- rep(tole_ids, each = 7)

# Simulate binary variables with reasonable probabilities
simulate_binary <- function(n, prob = 0.5) {
  rbinom(n, 1, prob)
}

# Simulate survey data
survey_data <- tibble(
  household_id = household_ids,
  tole = tole_assignment,

  # Demographics
  caregiver_educated = simulate_binary(140, 0.6),
  crowded_household = simulate_binary(140, 0.4),
  improved_floor = simulate_binary(140, 0.5),
  improved_water = simulate_binary(140, 0.7),
  improved_sanitation = simulate_binary(140, 0.65),
  handwashing_station = simulate_binary(140, 0.55),
  owns_animals = simulate_binary(140, 0.8),
  
  # Animal ownership
  owns_cow = simulate_binary(140, 0.8),
  owns_goat = simulate_binary(140, 0.7),
  owns_poultry = simulate_binary(140, 0.65),
  owns_dog = simulate_binary(140, 0.4)
)

# Biodigester waste use (conditional on animal ownership)
survey_data <- survey_data %>%
  mutate(
    cow_waste_into_digester = if_else(owns_cow == 1, simulate_binary(140, 0.8), 0),
    goat_waste_into_digester = if_else(owns_goat == 1, simulate_binary(140, 0.3), 0),
    poultry_waste_into_digester = if_else(owns_poultry == 1, simulate_binary(140, 0.2), 0),
    dog_waste_into_digester = if_else(owns_dog == 1, simulate_binary(140, 0.1), 0),
    waste_freq_per_week = sample(0:7, 140, replace = TRUE),
    biodigester_broken = simulate_binary(140, 0.64),
    mix_by_hand = simulate_binary(140, 0.4),
    effluent_resttime_months = sample(0:8, 140, replace = TRUE),
    effluent_applied_to_crops = simulate_binary(140, 0.8),
    effluent_applied_by_hand = if_else(effluent_applied_to_crops == 1, simulate_binary(140, 0.6), 0),
    effluent_applied_crop_1 = if_else(effluent_applied_to_crops == 1, simulate_binary(140, 0.8), 0),
    effluent_applied_crop_2 = if_else(effluent_applied_to_crops == 1, simulate_binary(140, 0.65), 0),
    effluent_applied_crop_3 = if_else(effluent_applied_to_crops == 1, simulate_binary(140, 0.7), 0),
    effluent_applied_crop_4 = if_else(effluent_applied_to_crops == 1, simulate_binary(140, 0.3), 0),
  )

# Child health
survey_data <- survey_data %>%
  mutate(
    child_has_diarrhea_7d = simulate_binary(140, 0.2)
  )

# View first few rows
print(head(survey_data))

# Optionally save as CSV
write_csv(survey_data, "/Users/hkamato/Desktop/GitHub/DHKUH Data Analysis Training/simulated_data/survey_data_simulated.csv")
```

## Simulate IDEXX data
```{r idexx}
# Helper function
simulate_quanti_tray_counts <- function(n) {
  tibble(
    small_cell_count = sample(0:49, n, replace = TRUE),
    large_cell_count = sample(0:48, n, replace = TRUE)
  )
}

n <- nrow(sample_metadata)  # 420

# IDEXX data
microbio_data <- sample_metadata %>%
  bind_cols(
    simulate_quanti_tray_counts(n) %>% rename_with(~paste0("total_coliform_", .)),
    simulate_quanti_tray_counts(n) %>% rename_with(~paste0("e_coli_", .)),
    simulate_quanti_tray_counts(n) %>% rename_with(~paste0("ar_total_coliform_", .)),
    simulate_quanti_tray_counts(n) %>% rename_with(~paste0("ar_e_coli_", .))
  )

# ESBL data
microbio_data <- microbio_data %>%
  mutate(
    plate_weight = case_when(sample_type == "effluent" | sample_type == "compost" ~ sample(0.301:0.425, n, replace = TRUE),
                             sample_type == "produce" ~ NA_real_),
    wet_weight = case_when(sample_type %in% c("effluent", "compost") ~ runif(n, min = 4.901, max = 5.125),
                           sample_type == "produce" ~ NA_real_),
    dry_weight = case_when(sample_type == "effluent" ~ sample(2.85:4.55, n, replace = TRUE),
                           sample_type == "compost" ~ sample(3.81:5.101, n, replace = TRUE),
                           sample_type == "produce" ~ NA_real_),
    esbl_e_coli_present = rbinom(n, 1, 0.3),
    esbl_e_coli_cfu = if_else(esbl_e_coli_present == 1, sample(1:250, n, replace = TRUE), 0)
  )

# Save and preview
head(microbio_data)

write_csv(microbio_data, "/Users/hkamato/Desktop/GitHub/DHKUH Data Analysis Training/simulated_data/microbial_data_simulated.csv")
```


## Simulate TAC data
```{r tac}

# Number of TAC cards needed: 7 samples per card
n_cards <- ceiling(nrow(sample_metadata) / 7)

# Simulate pathogen targets (you can customize this list)
targets <- c(
  # Bacteria
  "Campylobacter", "Salmonella", "Shigella", "E. coli O157", "ETEC", "EPEC", 
  "EAEC", "STEC", "Vibrio cholerae", "Yersinia enterocolitica",
  "Clostridium difficile", "Aeromonas", "Helicobacter pylori", 
  "Listeria monocytogenes", "Bacteroides fragilis",

  # Viruses
  "Norovirus GI", "Norovirus GII", "Rotavirus A", "Astrovirus", 
  "Adenovirus 40/41", "Sapovirus", "Enterovirus", "Hepatitis A", "Hepatitis E",

  # Protozoa
  "Giardia", "Cryptosporidium", "Entamoeba histolytica", 
  "Blastocystis", "Cyclospora", "Dientamoeba fragilis",

  # Helminths
  "Ascaris", "Trichuris", "Ancylostoma", "Necator", "Strongyloides",

  # Antibiotic Resistance Genes (optional group)
  "blaCTX-M", "blaNDM", "mecA", "tetA", "sul1", "qnrS",

  # Fecal markers / process controls
  "HF183", "CrAssphage", "Sketa22", "BacHum", "MS2", "Spiked_Extraction_Control", "No Template Control"
)

simulate_card_file <- function(card_num, samples_on_card, out_dir = "./simulated_data/simulated_cards") {
  # Add 8th sample as NTC
  ntc_sample <- tibble(
    sample_id = paste0("NTC_card", sprintf("%02d", card_num)),
    household_id = NA,
    sample_type = "NTC"
  )
  
  full_samples <- bind_rows(samples_on_card, ntc_sample)

  # Define TAC well layout (A1–H6, assuming 48 targets, 8 samples, 6 targets per column)
  wells <- paste0(rep(LETTERS[1:8], each = 6), rep(1:6, 8))

  # Expand data for all targets
  df <- expand_grid(
    Sample = full_samples$sample_id,
    Target = targets
  ) %>%
    arrange(Sample, Target) %>%
    mutate(
      Cq = ifelse(Sample == ntc_sample$sample_id, NA, ifelse(runif(n()) < 0.3, round(runif(n(), 20, 35), 2), NA_real_)),
      AMP = case_when(
        !is.na(Cq) ~ "Amp",
        runif(n()) < 0.1 ~ "Inconclusive",
        TRUE ~ "No Amp"
      ),
      `Amp Score` = ifelse(!is.na(Cq), round(runif(n(), 1.2, 2.0), 2), round(runif(n(), 0.0, 1.1), 2)),
      Result = case_when(
        !is.na(Cq) ~ "Positive",
        AMP == "Inconclusive" ~ "Equivocal",
        TRUE ~ "Negative"
      ),
      `Cq Conf` = ifelse(!is.na(Cq), round(runif(n(), 0.8, 1.0), 2), round(runif(n(), 0.0, 0.5), 2)),
      `Cq SD` = ifelse(!is.na(Cq), round(runif(n(), 0.1, 1.0), 2), NA_real_)
    )

  # Assign wells (repeat A1–H6 for each target)
  df <- df %>%
    group_by(Sample) %>%
    mutate(Well = rep(wells[1:length(targets)], length.out = n())) %>%
    ungroup()

  # Create output directory if needed
  dir.create(out_dir, showWarnings = FALSE)

  # Create safe filename
  date <- Sys.Date() + days(card_num)
  time <- format(Sys.time(), "%H%M%S")
  file_name <- paste0("card", sprintf("%02d", card_num), "_hka_", format(date, "%Y%m%d"),
                      "_Results_", format(date, "%Y%m%d"), "_", time, ".csv")

  # Write file
  write_csv(df, file.path(out_dir, file_name))

  return(file_name)
}

# Split across 60 cards
n_cards <- ceiling(nrow(sample_metadata) / 7)
card_files <- vector("character", n_cards)

for (i in 1:n_cards) {
  start <- (i - 1) * 7 + 1
  end <- min(i * 7, nrow(sample_metadata))
  card_samples <- sample_metadata[start:end, ]
  card_files[i] <- simulate_card_file(i, card_samples)
}

# Show generated files
print(card_files)
```